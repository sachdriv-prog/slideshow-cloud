name: Slideshow + Audio Mux (NO re-encode)

on:
  workflow_dispatch:

jobs:
  mux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        id: [1,2,3,4,5]

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install tools
      run: |
        sudo apt update
        sudo apt install -y ffmpeg
        pip install gdown pydrive2 oauth2client

    - name: Write Google Drive service account
      run: |
        echo '${{ secrets.GDRIVE_SA_JSON }}' > sa.json

    # ---------------- VIDEO LINKS ----------------
    - name: Set video URL
      run: |
        case "${{ matrix.id }}" in
          # Note: /u/ changed to /api/file/ for direct download
          1) echo "VIDEO_URL=https://pixeldrain.com/api/file/JS6Q9jnb" >> $GITHUB_ENV ;;
          2) echo "VIDEO_URL=https://pixeldrain.com/api/file/NyF1UQ5Q" >> $GITHUB_ENV ;;
          3) echo "VIDEO_URL=https://pixeldrain.com/api/file/ypSbjABE" >> $GITHUB_ENV ;;
          4) echo "VIDEO_URL=https://pixeldrain.com/api/file/jaqdrcsA" >> $GITHUB_ENV ;;
          5) echo "VIDEO_URL=https://pixeldrain.com/api/file/CFjsP8L1" >> $GITHUB_ENV ;;
        esac

    # ---------------- AUDIO LINKS ----------------
    - name: Set audio URL
      run: |
        case "${{ matrix.id }}" in
          1) echo "AUDIO_URL=https://drive.google.com/uc?id=1y-VwADH464i3OHZg3xPMXjnYmRxIZac3" >> $GITHUB_ENV ;;
          2) echo "AUDIO_URL=https://drive.google.com/uc?id=1kKdG4zda1NEFipq7nY9d_7gU7Yeiy1p3" >> $GITHUB_ENV ;;
          3) echo "AUDIO_URL=https://drive.google.com/uc?id=1fsvFri91k57y5AK9wNfxgPvTOtIx7X5T" >> $GITHUB_ENV ;;
          4) echo "AUDIO_URL=https://drive.google.com/uc?id=1En_WIU4lowecrjlfFSRolm9zHZ0PdiE9" >> $GITHUB_ENV ;;
          5) echo "AUDIO_URL=https://drive.google.com/uc?id=1QauDvFz0DmJkEixXtnpb9S31U6CrbeYI" >> $GITHUB_ENV ;;
        esac

    - name: Download slideshow video
      run: |
        curl -L "$VIDEO_URL" -o video.mp4

    - name: Download audio
      run: |
        gdown "$AUDIO_URL" -O audio.mp3

    - name: Validate files
      run: |
        ffprobe video.mp4
        ffprobe audio.mp3

    - name: Attach audio (NO re-encode)
      run: |
        ffmpeg -y \
          -i video.mp4 \
          -i audio.mp3 \
          -map 0:v:0 \
          -map 1:a:0 \
          -c copy \
          -shortest \
          final_${{ matrix.id }}.mp4

    - name: Upload to Google Drive
      run: |
        cat > upload.py << 'PY'
        from pydrive2.auth import GoogleAuth
        from pydrive2.drive import GoogleDrive
        from oauth2client.service_account import ServiceAccountCredentials
        import os

        VIDEO = f"final_{os.environ['MID']}.mp4"

        scope = ['https://www.googleapis.com/auth/drive']
        gauth = GoogleAuth()
        gauth.credentials = ServiceAccountCredentials.from_json_keyfile_name(
            'sa.json', scope
        )
        drive = GoogleDrive(gauth)

        f = drive.CreateFile({'title': VIDEO})
        f.SetContentFile(VIDEO)
        f.Upload()

        print("UPLOADED:", VIDEO)
        print("LINK:", f['alternateLink'])
        PY
        MID=${{ matrix.id }} python upload.py
