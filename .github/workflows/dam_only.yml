name: Slideshow + Audio Mux (NO re-encode)

on:
  workflow_dispatch:

jobs:
  mux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        id: [1,2,3,4,5]

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install tools
      run: |
        sudo apt update
        sudo apt install -y ffmpeg curl
        pip install gdown

    # ---------------- VIDEO LINKS ----------------
    - name: Set video URL
      run: |
        case "${{ matrix.id }}" in
          1) echo "VIDEO_URL=https://pixeldrain.com/api/file/JS6Q9jnb" >> $GITHUB_ENV ;;
          2) echo "VIDEO_URL=https://pixeldrain.com/api/file/NyF1UQ5Q" >> $GITHUB_ENV ;;
          3) echo "VIDEO_URL=https://pixeldrain.com/api/file/ypSbjABE" >> $GITHUB_ENV ;;
          4) echo "VIDEO_URL=https://pixeldrain.com/api/file/jaqdrcsA" >> $GITHUB_ENV ;;
          5) echo "VIDEO_URL=https://pixeldrain.com/api/file/CFjsP8L1" >> $GITHUB_ENV ;;
        esac

    # ---------------- AUDIO LINKS ----------------
    - name: Set audio URL
      run: |
        case "${{ matrix.id }}" in
          1) echo "AUDIO_URL=https://drive.google.com/file/d/1y-VwADH464i3OHZg3xPMXjnYmRxIZac3/view" >> $GITHUB_ENV ;;
          2) echo "AUDIO_URL=https://drive.google.com/file/d/1kKdG4zda1NEFipq7nY9d_7gU7Yeiy1p3/view" >> $GITHUB_ENV ;;
          3) echo "AUDIO_URL=https://drive.google.com/file/d/1fsvFri91k57y5AK9wNfxgPvTOtIx7X5T/view" >> $GITHUB_ENV ;;
          4) echo "AUDIO_URL=https://drive.google.com/file/d/1En_WIU4lowecrjlfFSRolm9zHZ0PdiE9/view" >> $GITHUB_ENV ;;
          5) echo "AUDIO_URL=https://drive.google.com/file/d/1QauDvFz0DmJkEixXtnpb9S31U6CrbeYI/view" >> $GITHUB_ENV ;;
        esac

    - name: Download slideshow video
      run: |
        curl -L "$VIDEO_URL" -o video.mp4

    - name: Download audio (Drive FIXED)
      run: |
        gdown --fuzzy "$AUDIO_URL" -O audio.mp3

    - name: Validate files
      run: |
        echo "=== VIDEO ==="
        ffprobe video.mp4
        echo "=== AUDIO ==="
        ffprobe audio.mp3

    - name: Attach audio (NO re-encode)
      run: |
        ffmpeg -y \
          -i video.mp4 \
          -i audio.mp3 \
          -map 0:v:0 \
          -map 1:a:0 \
          -c copy \
          -shortest \
          final_${{ matrix.id }}.mp4

    - name: Upload as artifact
      uses: actions/upload-artifact@v4
      with:
        name: final_${{ matrix.id }}
        path: final_${{ matrix.id }}.mp4
