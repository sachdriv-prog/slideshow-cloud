name: Video + Audio Mux (FAST, CLEAN)

on:
  workflow_dispatch:

jobs:
  mux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        id: [1,2,3,4,5]

    steps:
    - name: Install tools
      run: |
        sudo apt update
        sudo apt install -y ffmpeg curl rclone

    - name: Restore rclone config
      run: |
        mkdir -p ~/.config/rclone
        echo "${{ secrets.RCLONE_CONF }}" > ~/.config/rclone/rclone.conf

    # -------- SELECT LINKS --------
    - name: Select audio & video links
      run: |
        case "${{ matrix.id }}" in
          1)
            echo "AUDIO=https://drive.google.com/uc?id=1y-VwADH464i3OHZg3xPMXjnYmRxIZac3&export=download" >> $GITHUB_ENV
            echo "VIDEO=https://drive.google.com/uc?id=1Nijq_M6f73tcauIJxKJKvadYnjMl3_ER&export=download" >> $GITHUB_ENV
            ;;
          2)
            echo "AUDIO=https://drive.google.com/uc?id=1kKdG4zda1NEFipq7nY9d_7gU7Yeiy1p3&export=download" >> $GITHUB_ENV
            echo "VIDEO=https://drive.google.com/uc?id=1HJN7xXEDRBnclmSOxZ67ImKajxXoGf5t&export=download" >> $GITHUB_ENV
            ;;
          3)
            echo "AUDIO=https://drive.google.com/uc?id=1fsvFri91k57y5AK9wNfxgPvTOtIx7X5T&export=download" >> $GITHUB_ENV
            echo "VIDEO=https://drive.google.com/uc?id=11ZSqye0UzY1EDESK1TddTlEspGUdItZE&export=download" >> $GITHUB_ENV
            ;;
          4)
            echo "AUDIO=https://drive.google.com/uc?id=1En_WIU4lowecrjlfFSRolm9zHZ0PdiE9&export=download" >> $GITHUB_ENV
            echo "VIDEO=https://drive.google.com/uc?id=13-Osfv8RmSTYKwxoEztQJGE7FeEjuHcE&export=download" >> $GITHUB_ENV
            ;;
          5)
            echo "AUDIO=https://drive.google.com/uc?id=1QauDvFz0DmJkEixXtnpb9S31U6CrbeYI&export=download" >> $GITHUB_ENV
            echo "VIDEO=https://drive.google.com/uc?id=1ZhhcsSIxh9j9oLcqrcEd4KC_nEG1K9tP&export=download" >> $GITHUB_ENV
            ;;
        esac

    # -------- DOWNLOAD (NORMAL HTTP) --------
    - name: Download files (NORMAL)
      run: |
        curl -L "$VIDEO" -o video.mp4
        curl -L "$AUDIO" -o audio.mp3

    - name: Validate
      run: |
        ffprobe video.mp4
        ffprobe audio.mp3

    # -------- MUX (NO RE-ENCODE) --------
    - name: Attach audio to video
      run: |
        ffmpeg -y \
          -i video.mp4 \
          -i audio.mp3 \
          -map 0:v:0 \
          -map 1:a:0 \
          -c copy \
          -shortest \
          final_${{ matrix.id }}.mp4

    # -------- UPLOAD (ONLY rclone HERE) --------
    - name: Upload to your Google Drive
      run: |
        rclone copy final_${{ matrix.id }}.mp4 gdrive:/Final_Videos/
