name: Final Slideshow + Audio (No Re-encode â†’ Drive)

on:
  workflow_dispatch:

jobs:
  mux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        id: [1, 2, 3, 4, 5]

    steps:
    - name: Install tools
      run: |
        sudo apt update
        sudo apt install -y ffmpeg curl jq
        pip install gdown pydrive2

    - name: Setup Google Drive auth
      run: |
        echo '${{ secrets.GDRIVE_SA_JSON }}' > sa.json

    - name: Download slideshow + audio
      run: |
        mkdir work
        cd work

        if [ "${{ matrix.id }}" = "1" ]; then
          curl -L https://pixeldrain.com/api/file/JS6Q9jnb -o video.mp4
          gdown --id 1y-VwADH464i3OHZg3xPMXjnYmRxIZac3 -O audio.mp3

        elif [ "${{ matrix.id }}" = "2" ]; then
          curl -L https://pixeldrain.com/api/file/NyF1UQ5Q -o video.mp4
          gdown --id 1kKdG4zda1NEFipq7nY9d_7gU7Yeiy1p3 -O audio.mp3

        elif [ "${{ matrix.id }}" = "3" ]; then
          curl -L https://pixeldrain.com/api/file/ypSbjABE -o video.mp4
          gdown --id 1fsvFri91k57y5AK9wNfxgPvTOtIx7X5T -O audio.mp3

        elif [ "${{ matrix.id }}" = "4" ]; then
          curl -L https://pixeldrain.com/api/file/jaqdrcsA -o video.mp4
          gdown --id 1En_WIU4lowecrjlfFSRolm9zHZ0PdiE9 -O audio.mp3

        elif [ "${{ matrix.id }}" = "5" ]; then
          curl -L https://pixeldrain.com/api/file/CFjsP8L1 -o video.mp4
          gdown --id 1QauDvFz0DmJkEixXtnpb9S31U6CrbeYI -O audio.mp3
        fi

    - name: Validate files
      run: |
        cd work
        ffprobe video.mp4
        ffprobe audio.mp3

    - name: Attach audio to slideshow (NO re-encode)
      run: |
        cd work
        ffmpeg -y \
          -i video.mp4 \
          -i audio.mp3 \
          -t 11:55:00 \
          -map 0:v:0 \
          -map 1:a:0 \
          -c copy \
          -shortest \
          final_${{ matrix.id }}.mp4

    - name: Upload final video to Google Drive
      run: |
        python << 'EOF'
        from pydrive2.auth import GoogleAuth
        from pydrive2.drive import GoogleDrive

        gauth = GoogleAuth()
        gauth.LoadServiceConfigFile("sa.json")
        gauth.ServiceAuth()

        drive = GoogleDrive(gauth)

        file = drive.CreateFile({
            'title': f'final_video_${{ matrix.id }}.mp4'
        })
        file.SetContentFile(f'work/final_${{ matrix.id }}.mp4')
        file.Upload()

        print("===================================")
        print("GOOGLE DRIVE LINK:")
        print(file['alternateLink'])
        print("===================================")
        EOF
