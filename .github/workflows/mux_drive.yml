name: Drive Video + Audio Mux (NO re-encode)

on:
  workflow_dispatch:

jobs:
  mux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        id: [1,2,3,4,5]

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install tools
      run: |
        sudo apt update
        sudo apt install -y ffmpeg rclone

    - name: Restore rclone config
      run: |
        mkdir -p ~/.config/rclone
        echo "${{ secrets.RCLONE_CONF }}" > ~/.config/rclone/rclone.conf

    # ---------- SELECT FILES ----------
    - name: Select audio & video
      run: |
        case "${{ matrix.id }}" in
          1)
            echo "AUDIO=1y-VwADH464i3OHZg3xPMXjnYmRxIZac3" >> $GITHUB_ENV
            echo "VIDEO=1Nijq_M6f73tcauIJxKJKvadYnjMl3_ER" >> $GITHUB_ENV
            ;;
          2)
            echo "AUDIO=1kKdG4zda1NEFipq7nY9d_7gU7Yeiy1p3" >> $GITHUB_ENV
            echo "VIDEO=1HJN7xXEDRBnclmSOxZ67ImKajxXoGf5t" >> $GITHUB_ENV
            ;;
          3)
            echo "AUDIO=1fsvFri91k57y5AK9wNfxgPvTOtIx7X5T" >> $GITHUB_ENV
            echo "VIDEO=11ZSqye0UzY1EDESK1TddTlEspGUdItZE" >> $GITHUB_ENV
            ;;
          4)
            echo "AUDIO=1En_WIU4lowecrjlfFSRolm9zHZ0PdiE9" >> $GITHUB_ENV
            echo "VIDEO=13-Osfv8RmSTYKwxoEztQJGE7FeEjuHcE" >> $GITHUB_ENV
            ;;
          5)
            echo "AUDIO=1QauDvFz0DmJkEixXtnpb9S31U6CrbeYI" >> $GITHUB_ENV
            echo "VIDEO=1ZhhcsSIxh9j9oLcqrcEd4KC_nEG1K9tP" >> $GITHUB_ENV
            ;;
        esac

    # ---------- DOWNLOAD ----------
    - name: Download audio & video from Drive
      run: |
        rclone copy gdrive: "$PWD" \
          --drive-file-id "$AUDIO" \
          --drive-file-id "$VIDEO"

        mv *mp3 audio.mp3
        mv *mp4 video.mp4

    - name: Validate files
      run: |
        ffprobe audio.mp3
        ffprobe video.mp4

    # ---------- MUX (NO RE-ENCODE) ----------
    - name: Attach audio to video (FAST)
      run: |
        ffmpeg -y \
          -i video.mp4 \
          -i audio.mp3 \
          -map 0:v:0 \
          -map 1:a:0 \
          -c copy \
          -shortest \
          final_${{ matrix.id }}.mp4

    # ---------- UPLOAD BACK TO DRIVE ----------
    - name: Upload final video to Drive
      run: |
        rclone copy final_${{ matrix.id }}.mp4 gdrive:/Final_Videos/
