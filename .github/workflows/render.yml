name: Fast Parallel Slideshow

on:
  workflow_dispatch:

jobs:
  render:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        worker: [1, 2, 3, 4, 5]

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Install system tools
      run: |
        sudo apt update
        sudo apt install -y ffmpeg unzip curl
        pip install gdown

    - name: Download images from Google Drive
      run: |
        gdown --id 1fRbiu36873nfg6god2n_fzftVi-oXZjN -O images.zip
        unzip images.zip -d images

    - name: Render slideshow (JPEG)
      run: |
        ffmpeg -y \
        -framerate 1/5 \
        -pattern_type glob \
        -i "images/**/*.jpeg" \
        -vf "scale=1280:720,zoompan=z='min(zoom+0.0007,1.1)':d=150" \
        slideshow_${{ matrix.worker }}.mp4

    # üîê BACKUP (SO 30 MIN NEVER WASTED)
    - name: Backup slideshow as artifact
      uses: actions/upload-artifact@v4
      with:
        name: slideshow_${{ matrix.worker }}
        path: slideshow_${{ matrix.worker }}.mp4

    # üöÄ UPLOAD TO PIXELDRAIN (STABLE)
    - name: Upload to Pixeldrain
      run: |
        FILE="slideshow_${{ matrix.worker }}.mp4"
        echo "Uploading $FILE to Pixeldrain..."

        RESPONSE=$(curl -s -X POST \
          -F "file=@$FILE" \
          https://pixeldrain.com/api/file)

        echo "Raw response:"
        echo "$RESPONSE"

        LINK=$(echo "$RESPONSE" | sed -n 's/.*"id":"\([^"]*\)".*/https:\/\/pixeldrain.com\/u\/\1/p')

        echo "PIXELDRAIN LINK:"
        echo "$LINK"
