name: Random Parallel Slideshow + Upload

on:
  workflow_dispatch:

jobs:
  render:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        worker: [1, 2, 3, 4, 5]

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Install tools
      run: |
        sudo apt update
        sudo apt install -y ffmpeg unzip jq curl
        pip install gdown

    - name: Download images from Google Drive
      run: |
        gdown --id 1fRbiu36873nfg6god2n_fzftVi-oXZjN -O images.zip
        unzip images.zip -d images

    - name: Generate RANDOM image list (per worker)
      run: |
        echo "Generating random order for worker ${{ matrix.worker }}"

        find images -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" \) > images_all.txt

        shuf --random-source=<(yes ${{ matrix.worker }}) images_all.txt > images_shuffled.txt

        echo "Preview (first 10 images):"
        head images_shuffled.txt

        # Create FFmpeg concat list
        sed "s|^|file '|; s|$|'|" images_shuffled.txt > images_ffmpeg.txt

    - name: Render slideshow (RANDOM)
      run: |
        ffmpeg -y \
          -f concat -safe 0 -i images_ffmpeg.txt \
          -vf "scale=1280:720,zoompan=z='min(zoom+0.0007,1.15)':d=150" \
          -r 30 \
          slideshow_${{ matrix.worker }}.mp4

    - name: Backup slideshow as artifact
      uses: actions/upload-artifact@v4
      with:
        name: slideshow_${{ matrix.worker }}
        path: slideshow_${{ matrix.worker }}.mp4

    - name: Upload slideshow to Pixeldrain
      env:
        PIXELDRAIN_API_KEY: ${{ secrets.PIXELDRAIN_API_KEY }}
      run: |
        FILE="slideshow_${{ matrix.worker }}.mp4"
        echo "Uploading $FILE"

        RESPONSE=$(curl -s -u ":$PIXELDRAIN_API_KEY" \
          -F "file=@$FILE" \
          https://pixeldrain.com/api/file)

        echo "Raw response:"
        echo "$RESPONSE"

        ID=$(echo "$RESPONSE" | jq -r '.id // empty')

        if [ -n "$ID" ]; then
          echo "=============================="
          echo "PIXELDRAIN LINK:"
          echo "https://pixeldrain.com/u/$ID"
          echo "=============================="
        else
          echo "‚ùå Upload failed"
        fi
