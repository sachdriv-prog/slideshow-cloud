name: Fast Parallel Slideshow

on:
  workflow_dispatch:

jobs:
  render:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        worker: [1, 2, 3, 4, 5]

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Install system tools
      run: |
        sudo apt update
        sudo apt install -y ffmpeg unzip
        pip install gdown requests

    - name: Download images from Google Drive
      run: |
        gdown --id 1fRbiu36873nfg6god2n_fzftVi-oXZjN -O images.zip
        ls -lh
        unzip images.zip -d images

    - name: Render slideshow (JPEG)
      run: |
        echo "Listing images:"
        find images -type f

        ffmpeg -y \
        -framerate 1/5 \
        -pattern_type glob \
        -i "images/**/*.jpeg" \
        -vf "scale=1280:720,zoompan=z='min(zoom+0.0007,1.1)':d=150" \
        slideshow_${{ matrix.worker }}.mp4

    # üîê BACKUP ‚Äî THIS SAVES YOU FROM WASTING 30 MIN AGAIN
    - name: Backup slideshow as artifact
      uses: actions/upload-artifact@v4
      with:
        name: slideshow_${{ matrix.worker }}
        path: slideshow_${{ matrix.worker }}.mp4

    # üì§ SAFE GOFILE UPLOAD (NO CRASH EVEN IF RESPONSE IS BAD)
    - name: Upload to GoFile (SAFE)
      run: |
        python - << 'EOF'
        import requests, os

        filename = f"slideshow_{os.environ.get('MATRIX_WORKER','')}.mp4"
        if not os.path.exists(filename):
            files = [f for f in os.listdir('.') if f.startswith("slideshow_")]
            filename = files[0]

        print("Uploading:", filename)

        server_resp = requests.get("https://api.gofile.io/getServer")
        print("Server response:")
        print(server_resp.text)

        server = server_resp.json()["data"]["server"]

        upload = requests.post(
            f"https://{server}.gofile.io/uploadFile",
            files={"file": open(filename, "rb")}
        )

        print("Upload HTTP status:", upload.status_code)
        print("Upload raw response:")
        print(upload.text)

        try:
            data = upload.json()
            if data.get("status") == "ok":
                print("GOFILE LINK:", data["data"]["downloadPage"])
            else:
                print("Upload finished but unexpected JSON:", data)
        except Exception:
            print("Upload likely succeeded, but response was not JSON.")
            print("Check GoFile manually if needed.")
        EOF
