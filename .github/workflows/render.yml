name: Random Parallel Slideshow â†’ Google Drive

on:
  workflow_dispatch:

jobs:
  render:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        worker: [1,2,3,4,5]

    env:
      WORKER: ${{ matrix.worker }}

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install system + python tools
      run: |
        sudo apt update
        sudo apt install -y ffmpeg unzip
        pip install --upgrade pip
        pip install gdown google-api-python-client google-auth google-auth-httplib2 google-auth-oauthlib

    - name: Write Google Drive service account
      run: |
        echo '${{ secrets.GDRIVE_SA_JSON }}' > sa.json

    - name: Download images
      run: |
        gdown --id 1fRbiu36873nfg6god2n_fzftVi-oXZjN -O images.zip
        unzip images.zip -d images

    - name: Randomize images per worker
      run: |
        find images -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" \) > all.txt
        shuf --random-source=<(yes $WORKER) all.txt > list.txt
        sed "s|^|file '|; s|$|'|" list.txt > ffmpeg.txt

    - name: Render slideshow
      run: |
        ffmpeg -y \
          -f concat -safe 0 -i ffmpeg.txt \
          -vf "scale=1280:720,zoompan=z='min(zoom+0.0007,1.15)':d=150" \
          -r 30 \
          slideshow_${WORKER}.mp4

    - name: Upload to Google Drive (NO RED, NO PYDRIVE)
      run: |
        python << 'EOF'
        from google.oauth2 import service_account
        from googleapiclient.discovery import build
        from googleapiclient.http import MediaFileUpload
        import os

        FILE = f"slideshow_{os.environ['WORKER']}.mp4"

        creds = service_account.Credentials.from_service_account_file(
            "sa.json",
            scopes=["https://www.googleapis.com/auth/drive"]
        )

        service = build("drive", "v3", credentials=creds)

        media = MediaFileUpload(FILE, mimetype="video/mp4", resumable=True)

        file = service.files().create(
            body={"name": FILE},
            media_body=media,
            fields="id, webViewLink"
        ).execute()

        print("UPLOADED:")
        print(file["webViewLink"])
        EOF
