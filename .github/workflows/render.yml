name: Random Parallel Slideshow â†’ Google Drive

on:
  workflow_dispatch:

jobs:
  render:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        worker: [1, 2, 3, 4, 5]

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Install tools
      run: |
        sudo apt update
        sudo apt install -y ffmpeg unzip
        pip install gdown google-api-python-client google-auth google-auth-oauthlib

    - name: Write Google Drive service account
      run: |
        echo '${{ secrets.GDRIVE_SA_JSON }}' > sa.json

    - name: Download images from Google Drive
      run: |
        gdown --id 1fRbiu36873nfg6god2n_fzftVi-oXZjN -O images.zip
        unzip images.zip -d images

    - name: Generate RANDOM image list (per worker)
      run: |
        find images -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" \) > images_all.txt
        shuf --random-source=<(yes ${{ matrix.worker }}) images_all.txt > images_shuffled.txt
        sed "s|^|file '|; s|$|'|" images_shuffled.txt > images_ffmpeg.txt

    - name: Render slideshow (RANDOM)
      run: |
        ffmpeg -y \
          -f concat -safe 0 -i images_ffmpeg.txt \
          -vf "scale=1280:720,zoompan=z='min(zoom+0.0007,1.15)':d=150" \
          -r 30 \
          slideshow_${{ matrix.worker }}.mp4

    - name: Upload slideshow to Google Drive (Service Account)
      env:
        WORKER: ${{ matrix.worker }}
      run: |
        python << 'EOF'
from google.oauth2 import service_account
from googleapiclient.discovery import build
from googleapiclient.http import MediaFileUpload
import os

SCOPES = ['https://www.googleapis.com/auth/drive']
creds = service_account.Credentials.from_service_account_file(
    'sa.json', scopes=SCOPES
)

service = build('drive', 'v3', credentials=creds)

file_metadata = {
    'name': f'slideshow_{os.environ["WORKER"]}.mp4',
    # OPTIONAL: upload into a specific folder
    # 'parents': ['YOUR_FOLDER_ID_HERE']
}

media = MediaFileUpload(
    f'slideshow_{os.environ["WORKER"]}.mp4',
    mimetype='video/mp4',
    resumable=True
)

file = service.files().create(
    body=file_metadata,
    media_body=media,
    fields='id, webViewLink'
).execute()

print("=================================")
print("UPLOADED TO GOOGLE DRIVE")
print("LINK:", file.get('webViewLink'))
print("=================================")
EOF
