name: Upload Slideshows to Pixeldrain (Direct Artifact API)

on:
  workflow_dispatch:

jobs:
  upload:
    runs-on: ubuntu-latest

    steps:
    - name: Install tools
      run: |
        sudo apt update
        sudo apt install -y jq curl unzip

    - name: Download artifacts via GitHub API
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        mkdir artifacts
        cd artifacts

        # Artifact IDs from your render run
        ARTIFACTS=(
          4885841947
          4885817368
          4885815455
          4885815200
          4885824653
        )

        for ID in "${ARTIFACTS[@]}"; do
          echo "Downloading artifact $ID"
          curl -L \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/sachdriv-prog/slideshow-cloud/actions/artifacts/$ID/zip \
            -o artifact_$ID.zip

          unzip artifact_$ID.zip
        done

        echo "Downloaded files:"
        find . -type f

    - name: Upload MP4 files to Pixeldrain
      env:
        PIXELDRAIN_API_KEY: ${{ secrets.PIXELDRAIN_API_KEY }}
      run: |
        for file in artifacts/**/*.mp4; do
          echo "Uploading $file"

          RESPONSE=$(curl -s -u ":$PIXELDRAIN_API_KEY" \
            -F "file=@$file" \
            https://pixeldrain.com/api/file)

          echo "$RESPONSE"

          ID=$(echo "$RESPONSE" | jq -r '.id // empty')

          if [ -n "$ID" ]; then
            echo "PIXELDRAIN LINK:"
            echo "https://pixeldrain.com/u/$ID"
          else
            echo "‚ùå Upload failed for $file"
          fi

          echo "-----------------------------"
        done
