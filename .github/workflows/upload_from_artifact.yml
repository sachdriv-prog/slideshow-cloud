name: Upload Slideshows to Pixeldrain (Direct Artifact API)

on:
  workflow_dispatch:

jobs:
  upload:
    runs-on: ubuntu-latest

    steps:
    - name: Install tools
      run: |
        sudo apt update
        sudo apt install -y curl unzip jq

    - name: Download artifacts via GitHub API
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Downloading artifacts..."

        ARTIFACT_IDS=(
          4885841947
          4885817368
          4885815455
          4885815200
          4885824653
        )

        for ID in "${ARTIFACT_IDS[@]}"; do
          echo "Downloading artifact $ID"

          curl -L \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/sachdriv-prog/slideshow-cloud/actions/artifacts/$ID/zip \
            -o artifact_$ID.zip

          unzip -o artifact_$ID.zip
        done

        echo "Files extracted:"
        ls -lh *.mp4

    - name: Upload MP4 files to Pixeldrain
      env:
        PIXELDRAIN_API_KEY: ${{ secrets.PIXELDRAIN_API_KEY }}
      run: |
        echo "Starting upload to Pixeldrain..."

        for file in *.mp4; do
          echo "Uploading $file"

          RESPONSE=$(curl -s -u ":$PIXELDRAIN_API_KEY" \
            -F "file=@$file" \
            https://pixeldrain.com/api/file)

          echo "Raw response:"
          echo "$RESPONSE"

          ID=$(echo "$RESPONSE" | jq -r '.id // empty')

          if [ -n "$ID" ]; then
            echo "=============================="
            echo "PIXELDRAIN LINK:"
            echo "https://pixeldrain.com/u/$ID"
            echo "=============================="
          else
            echo "‚ùå Upload failed for $file"
          fi
        done
