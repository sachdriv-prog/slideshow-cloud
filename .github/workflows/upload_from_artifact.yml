name: Upload Slideshows to Pixeldrain (From Render Run)

on:
  workflow_dispatch:

jobs:
  upload:
    runs-on: ubuntu-latest

    steps:
    - name: Download artifacts from render run
      uses: actions/download-artifact@v4
      with:
        repository: sachdriv-prog/slideshow-cloud
        run-id: 20269412378
        path: artifacts
        merge-multiple: true

    - name: List downloaded files
      run: |
        echo "Downloaded files:"
        ls -R artifacts
        find artifacts -type f

    - name: Upload all slideshows to Pixeldrain
      env:
        PIXELDRAIN_API_KEY: ${{ secrets.PIXELDRAIN_API_KEY }}
      run: |
        set -e

        COUNT=0
        for file in artifacts/**/*.mp4; do
          echo "Uploading $file"

          RESPONSE=$(curl -s -u ":$PIXELDRAIN_API_KEY" \
            -F "file=@$file" \
            https://pixeldrain.com/api/file)

          echo "Raw response:"
          echo "$RESPONSE"

          ID=$(echo "$RESPONSE" | sed -n 's/.*"id":"\([^"]*\)".*/\1/p')

          if [ -n "$ID" ]; then
            echo "PIXELDRAIN LINK:"
            echo "https://pixeldrain.com/u/$ID"
            COUNT=$((COUNT+1))
          else
            echo "‚ùå Upload failed for $file"
          fi

          echo "---------------------------------"
        done

        echo "TOTAL UPLOADED FILES: $COUNT"
